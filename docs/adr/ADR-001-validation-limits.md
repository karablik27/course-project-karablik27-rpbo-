# ADR-001: Валидация и ограничение тела запроса (≤ 1 MB)

**Дата:** 2025-10-21
**Статус:** Accepted

---

## Context
Сервис OKR (FastAPI) предоставляет POST/PUT эндпоинты для создания/обновления сущностей `Objective` и `KeyResult`.
Без централизованного ограничения размера тела злоумышленник может отправлять чрезмерные payload'ы и перегружать приложение/воркеры (**DoS**).

Связанные требования и артефакты:
- **NFR-03 — Ограничение входных данных**: тело POST-запроса не превышает 1 MB (issue: #15).
- **DFD**: F24 (*BodySizeLimit middleware*), см. `docs/threat-model/DFD.md` (TB1/TB3).
- **Risk Register**: **R2 — Перегрузка большим телом (DoS)**.
- **Код**: `app/middleware/limits.py`.
- **Тесты**: `tests/test_limits.py` (сценарий «>1MB → 413/422»).

---

## Decision
Вводится централизованный middleware **`BodySizeLimitMiddleware`**, который:
1. Читает тело запроса `await request.body()`.
2. Проверяет длину; при превышении **1 MB** возвращает `413 Payload Too Large`.
3. Иначе передаёт управление дальше по пайплайну.

Технические параметры:
- Константа: `MAX_BODY_SIZE = 1 * 1024 * 1024` (1 MB).
- Подключение — в `app/main.py` **до** роутеров.

---

## Alternatives
1. **Ограничение на уровне роутеров** (валидация внутри хендлеров).
   **Минусы:** дублирование кода, легко пропустить новые эндпоинты.
   **Плюсы:** гибкость порогов на эндпоинт.
2. **Лимит на уровне ingress/proxy (Nginx `client_max_body_size`)**.
   **Минусы:** не виден из кода, сложнее покрывать unit-тестами; в dev окружении может отсутствовать.
   **Плюсы:** снимает нагрузку до приложения, полезно для prod.
3. **Комбинированный вариант (proxy + middleware)** — **выбранный в перспективе**.
   **Компромисс:** тестируем в коде (middleware) и дублируем лимит на периметре при деплое.

---

## Consequences / Security impact
- Снижается риск **R2 (DoS)**; сокращается время обработки крупных запросов.
- Отражение в метриках/КПЭ: доля ответов **413** на попытки превышения лимита; не растёт p95 по NFR‑01 из‑за крупных тел.
- Влияет на DX: клиенты получают предсказуемую ошибку (413) вместо таймаутов.
- Побочный эффект: одноразовое чтение `body` в middleware — учтено порядком middleware (см. DFD F21–F28).

---

## Acceptance Criteria (DoD) & Rollout Plan
**DoD:**
- [x] Middleware подключён в `app/main.py` (раньше роутеров).
- [x] Юнит‑тест `tests/test_limits.py` зелёный (проверка «>1MB → 413/422»).
- [x] Ревью соответствия **NFR-03** и **R2**.

**Rollout:**
- Этап 1 (dev): текущая реализация (middleware), наблюдаем логи.
- Этап 2 (prod): добавить лимит на ingress (Nginx) — **canary** на 10% трафика, затем 100%.
- Feature flag не требуется; порог может выноситься в env при необходимости.

---

## Links
- **NFR-03**, issue: #15
- **Threat Model**: DFD (F24, TB1/TB3), STRIDE/Risk **R2**
- **Код**: `app/middleware/limits.py`, `app/main.py`
- **Тесты**: `tests/test_limits.py`
- **PR**: `p05-secure-coding → main`
- Feature-flag: `BODY_LIMIT_ENABLED` (по умолчанию `"1"`). Если `"0"`, middleware не подключаем.
- Порог: `MAX_BODY_SIZE` через env (байты), для пилота можно поставить 512_000.
- Canary: на ingress (Nginx) включаем `client_max_body_size` только на 10% инстансов, затем 100%.
- Мониторинг: доля ответов 413 и влияние на p95 (NFR-01).
